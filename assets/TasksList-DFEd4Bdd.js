import{_ as E,r as w,c as b,u as C,m as j,w as U,a as i,b as s,e as k,f as T,F as h,j as y,v as S,g as D,t as u,h as F,o as n,p as V,q as P,d as f,k as R,l as B}from"./index-CH_ZDy35.js";const L={name:"TaskForm",props:{initialData:{type:Object,default:()=>({})}},emits:["submit"],setup(r,{emit:e}){const d=C(),t=w({project_id:"",title:"",description:"",status:5,user_ids:[]}),v=b(()=>r.initialData&&!!r.initialData.id),x=b(()=>d.getters["users/assignableUsers"]),a=b(()=>d.getters["projects/allProjects"]);return j(()=>{d.dispatch("users/fetchAssignableUsers"),d.dispatch("projects/fetchProjects")}),U(()=>r.initialData,c=>{var p;const l=c||{};t.value={project_id:l.project_id||"",title:l.title||"",description:l.description||"",status:l.status||5,user_ids:((p=l.users)==null?void 0:p.map(g=>g.id))||[]}},{immediate:!0}),{form:t,isEdit:v,handleSubmit:async()=>{var c;try{const l={title:t.value.title,description:t.value.description,status:t.value.status,project_id:t.value.project_id};let p;if(v.value)await d.dispatch("tasks/updateTask",{id:r.initialData.id,data:l}),p=r.initialData.id;else{await d.dispatch("tasks/createTask",l),await d.dispatch("tasks/fetchTasks");const g=d.getters["tasks/allTasks"];p=(c=g[g.length-1])==null?void 0:c.id}p&&t.value.user_ids.length>0&&(await d.dispatch("tasks/assignUsersToTask",{id:p,users:t.value.user_ids}),await d.dispatch("tasks/fetchTasks")),e("submit")}catch(l){console.error("Error al guardar la tarea:",l),alert("Error al guardar la tarea. Revisa los campos o contacta al administrador.")}},availableUsers:x,projects:a}}},N=["value"],q={class:"max-h-40 overflow-y-auto border p-2 rounded"},z=["value"],A={class:"text-right"},G={type:"submit",class:"bg-blue-600 text-white px-4 py-2 rounded"};function I(r,e,d,t,v,x){return n(),i("form",{onSubmit:e[5]||(e[5]=F((...a)=>t.handleSubmit&&t.handleSubmit(...a),["prevent"])),class:"space-y-4"},[s("div",null,[e[7]||(e[7]=s("label",{class:"block text-sm font-medium text-gray-700"},"Proyecto",-1)),k(s("select",{"onUpdate:modelValue":e[0]||(e[0]=a=>t.form.project_id=a),class:"w-full border p-2 rounded",required:""},[e[6]||(e[6]=s("option",{disabled:"",value:""},"Selecciona un proyecto",-1)),(n(!0),i(h,null,y(t.projects,a=>(n(),i("option",{key:a.id,value:a.id},u(a.name),9,N))),128))],512),[[T,t.form.project_id]])]),s("div",null,[e[8]||(e[8]=s("label",{class:"block text-sm font-medium text-gray-700"},"Título",-1)),k(s("input",{"onUpdate:modelValue":e[1]||(e[1]=a=>t.form.title=a),type:"text",class:"w-full border p-2 rounded",required:""},null,512),[[S,t.form.title]])]),s("div",null,[e[9]||(e[9]=s("label",{class:"block text-sm font-medium text-gray-700"},"Descripción",-1)),k(s("textarea",{"onUpdate:modelValue":e[2]||(e[2]=a=>t.form.description=a),class:"w-full border p-2 rounded",rows:"3"},null,512),[[S,t.form.description]])]),s("div",null,[e[11]||(e[11]=s("label",{class:"block text-sm font-medium text-gray-700"},"Estado",-1)),k(s("select",{"onUpdate:modelValue":e[3]||(e[3]=a=>t.form.status=a),class:"w-full border p-2 rounded",required:""},e[10]||(e[10]=[D('<option value="1">En proceso</option><option value="2">Finalizada</option><option value="3">En pruebas</option><option value="4">Bug</option><option value="5">En espera de asignación</option>',5)]),512),[[T,t.form.status]])]),s("div",null,[e[12]||(e[12]=s("label",{class:"block text-sm font-medium text-gray-700 mb-1"},"Usuarios asignados",-1)),s("div",q,[(n(!0),i(h,null,y(t.availableUsers,a=>(n(),i("label",{key:a.id,class:"block text-sm text-gray-700"},[k(s("input",{type:"checkbox",value:a.id,"onUpdate:modelValue":e[4]||(e[4]=o=>t.form.user_ids=o),class:"mr-2"},null,8,z),[[P,t.form.user_ids]]),V(" "+u(a.name)+" ("+u(a.role)+") ",1)]))),128))])]),s("div",A,[s("button",G,u(t.isEdit?"Guardar cambios":"Crear tarea"),1)])],32)}const O=E(L,[["render",I]]),H={name:"TasksList",components:{TaskForm:O},setup(){const r=C(),e=b(()=>r.getters["tasks/allTasks"]),d=b(()=>r.state.tasks.loading),t=b(()=>r.state.tasks.error),v=b(()=>r.getters["auth/userRole"]),x=b(()=>["Developer","Tester","Planning"].includes(v.value)),a=w(!1),o=w(null),c=()=>r.dispatch("tasks/fetchTasks"),l=()=>{c(),_()};j(()=>{c()});const p=()=>{o.value=null,a.value=!0},g=m=>{o.value=m,a.value=!0},_=()=>{o.value=null,a.value=!1};return{tasks:e,loading:d,error:t,userRole:v,canChangeStatus:x,showModal:a,editingTask:o,openCreateModal:p,openEditModal:g,closeModal:_,handleFormSubmit:async m=>{try{o.value?await r.dispatch("tasks/updateTask",{id:o.value.id,data:m}):await r.dispatch("tasks/createTask",m),await c(),_()}catch{alert("Error al guardar tarea")}},handleDelete:async m=>{confirm("¿Eliminar esta tarea?")&&(await r.dispatch("tasks/deleteTask",m),await c())},changeStatus:async m=>{try{await r.dispatch("tasks/changeTaskStatus",{id:m.id,status:m.status})}catch{alert("Error al cambiar el estado de la tarea")}},fetchTasks:c,onFormSuccess:l}}},J={class:"p-6"},K={class:"flex justify-between items-center mb-4"},Q={key:0,class:"text-gray-500"},W={key:1,class:"text-red-500"},X={key:2},Y={class:"w-full bg-white shadow rounded overflow-hidden"},Z={class:"px-4 py-2"},$={class:"px-4 py-2 capitalize"},tt={key:0},et=["onUpdate:modelValue","onChange"],st={key:1},at={class:"px-4 py-2"},ot={class:"text-sm list-disc list-inside text-gray-600"},lt={class:"px-4 py-2 text-center flex justify-center gap-2 flex-wrap"},it=["onClick"],nt=["onClick"],rt={key:3,class:"fixed inset-0 bg-black/70 flex items-center justify-center z-20"},dt={class:"bg-white p-6 rounded-lg shadow-lg w-full max-w-lg relative"},ct={class:"text-lg font-bold mb-4"};function ut(r,e,d,t,v,x){const a=B("TaskForm");return n(),i("div",J,[s("div",K,[e[2]||(e[2]=s("h1",{class:"text-2xl font-bold"},"Tareas",-1)),t.userRole==="Planning"?(n(),i("button",{key:0,onClick:e[0]||(e[0]=(...o)=>t.openCreateModal&&t.openCreateModal(...o)),class:"bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700"}," + Crear tarea ")):f("",!0)]),t.loading?(n(),i("div",Q,"Cargando tareas...")):t.error?(n(),i("div",W,u(t.error),1)):(n(),i("div",X,[s("table",Y,[e[4]||(e[4]=s("thead",{class:"bg-gray-100 text-left text-sm uppercase"},[s("tr",null,[s("th",{class:"px-4 py-2"},"Título"),s("th",{class:"px-4 py-2"},"Proyecto"),s("th",{class:"px-4 py-2"},"Estado"),s("th",{class:"px-4 py-2"},"Usuarios"),s("th",{class:"px-4 py-2 text-center"},"Acciones")])],-1)),s("tbody",null,[(n(!0),i(h,null,y(t.tasks,o=>{var c;return n(),i("tr",{key:o.id,class:"border-t hover:bg-gray-50"},[s("td",Z,u(o.title),1),s("td",null,u(((c=o.project)==null?void 0:c.name)||"Sin proyecto"),1),s("td",$,[t.canChangeStatus?(n(),i("div",tt,[k(s("select",{"onUpdate:modelValue":l=>o.status=l,onChange:l=>t.changeStatus(o),class:"border p-1 text-sm rounded"},e[3]||(e[3]=[D('<option value="1">En proceso</option><option value="2">Finalizada</option><option value="3">En pruebas</option><option value="4">Bug</option><option value="5">En espera de asignación</option>',5)]),40,et),[[T,o.status]])])):(n(),i("div",st,u(o.statusLabel),1))]),s("td",at,[s("ul",ot,[(n(!0),i(h,null,y(o.users,l=>(n(),i("li",{key:l.id},u(l.name)+" ("+u(l.roleLabel||"Sin rol")+") ",1))),128))])]),s("td",lt,[t.userRole==="Planning"?(n(),i("button",{key:0,onClick:l=>t.openEditModal(o),class:"text-blue-600 text-sm hover:underline"}," Editar ",8,it)):f("",!0),t.userRole==="Planning"?(n(),i("button",{key:1,onClick:l=>t.handleDelete(o.id),class:"text-red-600 text-sm hover:underline"}," Eliminar ",8,nt)):f("",!0)])])}),128))])])])),t.showModal?(n(),i("div",rt,[s("div",dt,[s("h2",ct,u(t.editingTask?"Editar tarea":"Crear nueva tarea"),1),R(a,{initialData:t.editingTask,onSubmit:t.onFormSuccess},null,8,["initialData","onSubmit"]),s("button",{onClick:e[1]||(e[1]=(...o)=>t.closeModal&&t.closeModal(...o)),class:"absolute top-2 right-3 text-gray-600 text-xl hover:text-black"}," × ")])])):f("",!0)])}const gt=E(H,[["render",ut]]);export{gt as default};
